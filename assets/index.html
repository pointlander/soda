<html>
 <head>
  <meta charset="UTF-8">
  <title>Soda</title>
  <style>
   table td, table td * {
       vertical-align: top;
   }
  </style>
 </head>
 <body>
  <table>
   <tr>
    <td>
     <form id="form">
      <textarea id="query" rows="20" cols="80"></textarea>
      <pre id="text"></pre><br/>
      <input type="submit"/>
     </form>
    </td>
    <td>
     <pre id="bible"></pre>
    </td>
   </tr>
  </table>
  <script type="text/javascript">
   function isDisplayable(char) {
    return /[\x20-\x7E]/.test(char);
   }
   function isPrintableSurrogatePair(codePoint) {
     return codePoint >= 0x20 && codePoint <= 0x10FFFF && // Unicode printable range
            !isControlCharacter(codePoint); // Exclude control characters
   }
   function isControlCharacter(codePoint) {
     return (codePoint >= 0x00 && codePoint <= 0x1F) ||
            (codePoint >= 0x7F && codePoint <= 0x9F);
   }
   function selectTextRange(element, start, end) {
     const range = document.createRange();
     range.setStart(element.firstChild, start);
     range.setEnd(element.firstChild, end);
     const selection = window.getSelection();
     selection.removeAllRanges();
     selection.addRange(range);
   }
   function bibleclick(c) {
     var text = document.getElementById('bible');
     var index = 0
     const value = text.innerHTML;
     var i = 0;
     var last;
     for (const char of value) {
      if (!(i < c)) {
       break;
      }
      //if (isPrintableSurrogatePair(char.codePointAt(0))) {
      if (isDisplayable(char)) {
       index++;
       last = char;
      }
      i++;
     }
     console.log(last.codePointAt(0));
     console.log(last);
     console.log(c);
     text.focus();
     index--;
     selectTextRange(text, index, index+1); 
   }
   fetch("/bible",
   {
    method: "GET"
   })
   .then(function(response){ 
    return response.text(); 
   })
   .then(function(data){ 
    document.getElementById('bible').innerHTML = data;
   });
   function submit(event) {
    event.preventDefault();
    query = document.getElementById('query').value;
    fetch("/infer",
    {
     method: "POST",
     body: query
    })
    .then(function(response){ 
     return response.text(); 
    })
    .then(function(data){
     const j = JSON.parse(data);
     var h = "";
     for (const s of j) {
      h += "<span onclick=\"bibleclick("+s.index+")\" style=\"padding: 0; margin: 0;\">"
      h += String.fromCharCode(s.symbol)
      h += "</span>"
     }
     document.getElementById('text').innerHTML = h;
    });
    return false;
   }
   var form = document.getElementById("form");
   form.addEventListener('submit', submit);
  </script>
 </body>
</html>
