<html>
 <head>
  <meta charset="UTF-8">
  <title>Soda</title>
  <style>
   table td, table td * {
       vertical-align: top;
   }
  </style>
 </head>
 <body>
  <table>
   <tr>
    <td>
     <form id="form">
      <textarea id="query" rows="20" cols="80"></textarea>
      <pre id="text"></pre><br/>
      <input type="submit"/>
     </form>
    </td>
    <td>
     <textarea id="bible" rows="40" cols="80"></textarea>
    </td>
   </tr>
  </table>
  <script type="text/javascript">
   function isDisplayable(char) {
    return /[\x20-\x7E]/.test(char);
   }
   function isPrintableSurrogatePair(codePoint) {
     return codePoint >= 0x20 && codePoint <= 0x10FFFF && // Unicode printable range
            !isControlCharacter(codePoint); // Exclude control characters
   }
   function isControlCharacter(codePoint) {
     return (codePoint >= 0x00 && codePoint <= 0x1F) ||
            (codePoint >= 0x7F && codePoint <= 0x9F);
   }
   function bibleclick(c) {
     var text = document.getElementById('bible');
     var index = 0
     const value = text.value;
     var i = 0;
     for (const char of value) {
      if (isPrintableSurrogatePair(char.codePointAt(0))) {
       index++;
      }
      i++;
      if (i > c) {
       break;
      }
     }
     text.focus();
     text.setSelectionRange(index, index+1);
   }
   fetch("/bible",
   {
    method: "GET"
   })
   .then(function(response){ 
    return response.text(); 
   })
   .then(function(data){ 
    document.getElementById('bible').value = data;
   });
   function submit(event) {
    event.preventDefault();
    query = document.getElementById('query').value;
    fetch("/infer",
    {
     method: "POST",
     body: query
    })
    .then(function(response){ 
     return response.text(); 
    })
    .then(function(data){
     const j = JSON.parse(data);
     var h = "";
     for (const s of j) {
      h += "<span onclick=\"bibleclick("+s.index+")\" style=\"padding: 0; margin: 0;\">"
      h += String.fromCharCode(s.symbol)
      h += "</span>"
     }
     document.getElementById('text').innerHTML = h;
    });
    return false;
   }
   var form = document.getElementById("form");
   form.addEventListener('submit', submit);
  </script>
 </body>
</html>
